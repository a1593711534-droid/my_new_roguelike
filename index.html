<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Elemental Survivor: Modularized</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://pixijs.download/release/pixi.min.js"></script>
</head>
<body>

    <canvas id="gameCanvas"></canvas>
    
    <div id="joystick-area"><div id="joy-base"><div id="joy-stick"></div></div></div>
    
    <div id="dash-btn" class="control-btn">
        <div class="btn-icon">⚡</div>
        <div class="cd-overlay" id="dash-cd-overlay"></div>
    </div>

    <div id="toast-container"></div>

    <div id="ui-layer">
        <div id="hud">
            <div class="top-info">
                <div style="text-align: left;">
                    <div style="margin-bottom:8px; display:flex; gap:5px;">
                        <div class="stat-box">WAVE <span id="ui-wave-num" style="color:#0ff;">1</span></div>
                        <div class="stat-box">LV <span id="ui-lvl" style="color:#0f0;">1</span></div>
                        <div class="stat-box" style="color:#ffd700; border-color:rgba(255,215,0,0.5);">$ <span id="ui-gold">0</span></div>
                    </div>
                    <div class="bar-group">
                        <div id="hp-container"><div id="hp-fill"></div><div id="hp-text">100 / 100</div></div>
                        <div id="xp-container"><div id="xp-fill"></div></div>
                    </div>
                </div>
                <div style="text-align: right; display:flex; gap:8px; align-items:flex-start;">
                     <div class="stat-box">💀 <span id="ui-kills">0</span></div>
                     <div class="stat-box" style="min-width:70px;">⏳ <span id="ui-time">30:00</span></div>
                     <div id="btn-pause" onclick="togglePause()" ontouchstart="togglePause()">⏸</div>
                </div>
            </div>
        </div>
        
        <div id="pause-overlay">
             <h1 class="neon-text">PAUSED</h1>
             <div style="font-size:14px; color:#888; margin-bottom:30px; font-family:'Orbitron'; letter-spacing: 2px;">SYSTEM HALTED</div>
             <button class="btn btn-gold" style="font-size: 18px; padding: 15px 60px; width:260px; margin-bottom:15px;" onclick="resumeGame()" ontouchstart="resumeGame()">繼續戰鬥</button>
             <button class="btn" style="font-size: 16px; padding: 12px 60px; width:260px; margin-bottom:15px; border-color:#00aaff; color:#00aaff;" onclick="openGearViewer()" ontouchstart="openGearViewer()">檢視裝備</button>
             <button class="btn btn-danger" style="font-size: 16px; padding: 12px 60px; width:260px;" onclick="restartGame()" ontouchstart="restartGame()">重新開始</button>
        </div>

        <div id="combat-bar"></div>
        <div id="skill-detail-popup"></div>

        <div id="start-modal" class="modal glass-panel" style="display:block;">
            <div class="modal-header" style="justify-content:center; height:60px;">
                 <h2 class="modal-title" style="font-size:20px;">選擇初始裝備</h2>
            </div>
            <div class="modal-body" style="justify-content: center; padding: 20px;">
                <div class="card-grid" id="start-cards" style="flex:1; align-content: center;"></div>
            </div>
        </div>

        <div id="levelup-modal" class="level-modal glass-panel">
            <div class="lvl-header">
                <span class="lvl-title">LEVEL UP</span>
                <span class="lvl-gold-tag">$ <span id="lvl-gold-display">0</span></span>
            </div>
            
            <div class="lvl-body-layout">
                <div class="lvl-left-panel">
                    <div id="lvl-info-container" style="display:none; flex-direction:column; height:100%;">
                        <div class="info-title" id="lvl-info-name"></div>
                        <div class="meta-row" id="lvl-meta-row" style="margin: 10px 0;"></div>
                        <div id="lvl-info-desc" class="info-desc" style="flex:1; font-size:14px; color:#ccc;"></div>
                        <div id="lvl-info-effect" class="info-effect"></div>
                    </div>
                    <div id="lvl-placeholder" style="display:flex; align-items:center; justify-content:center; height:100%; color:#666; font-size:14px; letter-spacing:1px;">
                        &lt; 選擇獎勵 (自動裝備/放入背包) &gt;
                    </div>
                    <div style="margin-top: auto; width: 100%; display: flex; justify-content: center; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <button class="btn" style="font-size: 12px; padding: 8px 20px; color:#aaa; border-color:#555;" onclick="openGearViewer()">檢視目前配裝</button>
                    </div>
                </div>

                <div class="lvl-right-panel">
                    <div class="lvl-rewards-box">
                        <div class="card-grid lvl-grid" id="levelup-cards"></div>
                    </div>
                    
                    <div class="lvl-controls">
                        <button class="btn" style="flex:1;" onclick="rerollLevelUp()">重新掃描 ($<span id="cost-reroll-lvl">0</span>)</button>
                        <button class="btn" id="btn-lvl-confirm" style="flex:1.5;" onclick="confirmLevelUp()" disabled>確認選擇</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="shop-modal" class="modal glass-panel">
            <div class="modal-header">
                <div style="display:flex; align-items:center; gap:15px;">
                    <span class="modal-title" style="font-size:18px;">實驗室 (Wave Complete)</span>
                    <span class="currency-badge">$ <span id="shop-gold-display">0</span></span>
                </div>
                <button class="btn btn-gold" onclick="closeShop()" style="width:140px; font-size:14px;">下一波 &gt;&gt;</button>
            </div>
            
            <div class="modal-body">
                
                <div class="dashboard-row">
                    <div class="col col-info">
                        <div class="col-header">資訊分析</div>
                        <div class="info-content">
                            <div class="info-title" id="dash-info-name">等待指令</div>
                            <div class="meta-row" id="dash-meta-row">
                                <span class="type-badge" style="color:#666; border-color:#333;">系統待機</span>
                            </div>
                            <div id="dash-info-desc" class="info-desc">請選擇項目後，點擊右側融合槽進行配置。</div>
                            <div id="dash-info-effect" class="info-effect"></div>
                        </div>
                    </div>

                    <div class="col col-shop">
                        <div class="col-header">補給站</div>
                        <div class="shop-grid" id="shop-cards"></div>
                        <div style="display:flex; gap:8px; margin-top:8px; padding:0 5px;">
                            <button class="btn" style="flex:1;" onclick="rerollShop()">刷新 $<span id="cost-reroll-shop">200</span></button>
                            <button id="btn-buy-confirm" class="btn" style="flex:1.5;" onclick="buySelectedShopItem()">購買</button>
                        </div>
                    </div>

                    <div class="col col-forge">
                        <div class="col-header">元素工坊</div>
                        <div id="forge-status-header" class="forge-status-header">編輯對象: 空</div>
                        <div id="socket-area"></div>
                        <div class="forge-controls">
                            <div style="display:flex; gap:5px; width:100%;">
                                <button class="btn" onclick="forgeAction('socket')" style="flex:1;">洗孔 $100</button>
                                <button class="btn" onclick="forgeAction('link')" style="flex:1;">洗鏈 $80</button>
                            </div>
                            <div style="display:flex; gap:5px; width:100%; margin-top:5px;">
                                <button class="btn" id="btn-unsocket-gem" onclick="unsocketItem()" disabled style="flex:1; font-size:10px;">拆卸寶石</button>
                                <button class="btn btn-danger" id="btn-unequip-gear" onclick="unequipGear()" disabled style="flex:1; font-size:10px;">卸下裝備</button>
                            </div>
                        </div>
                    </div>

                    <div class="col col-equipment">
                        <div class="col-header">全身裝備 (6)</div>
                        <div id="equipment-list-v" class="e-v-list"></div>
                    </div>

                    <div class="col col-fusion" style="display:flex; flex-direction:column; overflow:hidden;">
                        <div class="col-header" style="flex-shrink:0;">融合</div>
                        
                        <div class="fusion-box" style="display:flex; flex-direction:column; flex:1; height:100%; overflow:hidden; padding-bottom:5px;">
                            
                            <div class="fusion-slots" style="flex-shrink:0; margin-bottom:5px;">
                                <div style="font-size:10px; color:#888; margin-bottom:4px;">主體</div>
                                <div class="f-slot" id="f-main" onclick="placeSelectionInFusion('main')"><span style="font-size:10px;color:#555;">空</span></div>
                            </div>
                            
                            <div id="f-materials-container" style="flex:1; width:100%; display:flex; flex-direction:column; min-height:0; overflow:hidden; background:rgba(0,0,0,0.2); border-radius:4px; padding:4px;">
                                <div style="font-size:10px; color:#888; margin-bottom:4px; flex-shrink:0; text-align:center;">素材 (可複選)</div>
                                <div id="f-materials-list" style="flex:1; width:100%; overflow-y:auto; display:flex; flex-wrap:wrap; gap:4px; align-content:flex-start; justify-content:center;">
                                    <span style="font-size:10px; color:#444; margin-top:10px;">請點選背包素材</span>
                                </div>
                            </div>

                            <div id="fusion-msg" style="flex-shrink:0; height:14px; font-size:10px; color:#f55; text-align:center; margin-top: 5px;"></div>
                            
                            <div class="fusion-controls" style="flex-shrink:0; display:flex; gap:5px; width:100%; margin-top:5px;">
                                <button class="btn" id="btn-fuse-cancel" onclick="cancelFusion()" disabled style="flex:1; font-size:10px; border-color:#666;">取消</button>
                                <button class="btn btn-gold" id="btn-fuse-confirm" onclick="doFusion()" disabled style="flex:1; font-size:10px;">確定</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="inventory-container">
                    <div class="inv-panel" style="border-color: rgba(0, 255, 0, 0.3);">
                        <div class="inv-header">
                            <span style="color:#6f6;">主動核心</span>
                            <div class="sort-toolbar">
                                <button class="sort-btn" onclick="toggleInvSort('active', 'method')">TYPE</button>
                                <button class="sort-btn" onclick="toggleInvSort('active', 'order')">DIR</button>
                            </div>
                        </div>
                        <div id="inv-active-list" class="inv-list"></div>
                    </div>
                    
                    <div class="inv-panel" style="border-color: rgba(0, 204, 255, 0.3);">
                        <div class="inv-header">
                            <span style="color:#6cf;">輔助觸媒</span>
                            <div class="sort-toolbar">
                                <button class="sort-btn" onclick="toggleInvSort('support', 'method')">TYPE</button>
                                <button class="sort-btn" onclick="toggleInvSort('support', 'order')">DIR</button>
                            </div>
                        </div>
                        <div id="inv-support-list" class="inv-list"></div>
                    </div>

                    <div class="inv-panel" style="border-color: rgba(255, 215, 0, 0.3);">
                        <div class="inv-header">
                            <span style="color:#fd0;">裝備背包</span>
                            <div class="sort-toolbar">
                                <button class="sort-btn" onclick="toggleInvSort('equipment', 'method')">SORT</button>
                                <button class="sort-btn" onclick="toggleInvSort('equipment', 'order')">DIR</button>
                            </div>
                        </div>
                        <div id="inv-equip-list" class="inv-list"></div>
                    </div>
                </div>

            </div>
        </div>

        <div id="gameover-modal" class="modal glass-panel" style="padding:30px; height:auto; width: 360px; text-align:center; border: 2px solid #ff4444;">
            <h1 style="color:#ff4444; font-family:'Orbitron'; font-size:32px; letter-spacing:4px; margin-bottom:20px; text-shadow: 0 0 20px rgba(255,0,0,0.5);">任務失敗</h1>
            <div style="background:rgba(0,0,0,0.6); padding:15px; border-radius:8px; margin-bottom:25px; border:1px solid #444;">
                <p style="font-family:'Orbitron'; color:#ccc; margin:8px 0; font-size:16px;">進度: <span id="score-time" style="color:#fff; font-weight:bold;">Wave 1</span></p>
                <p style="font-family:'Orbitron'; color:#ccc; margin:8px 0; font-size:16px;">擊殺: <span id="score-kills" style="color:#fff; font-weight:bold;">0</span></p>
            </div>
            <button class="btn btn-gold" style="width:100%; padding:15px; font-size:16px;" onclick="location.reload()">重啟實驗</button>
        </div>
    </div>
    <div id="gear-viewer-modal" class="modal glass-panel" style="z-index: 6000; background: rgba(8, 10, 15, 0.98);">
        <div class="gv-header">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div class="gv-icon-box">🛡️</div>
                <h2 class="neon-text" style="font-size: 24px; margin: 0; color: #00aaff; text-shadow: 0 0 10px rgba(0,170,255,0.5);">AGENT DATABASE</h2>
            </div>
            
            <div class="gv-tabs">
                <button class="gv-tab active" id="tab-btn-loadout" onclick="switchGearView('loadout')">LOADOUT (裝備中)</button>
                <button class="gv-tab" id="tab-btn-inventory" onclick="switchGearView('inventory')">INVENTORY (背包)</button>
            </div>

            <button class="btn btn-danger" style="padding: 5px 15px; font-size: 16px;" onclick="closeGearViewer()">✕</button>
        </div>
        
        <div class="gv-body">
            <div class="gv-slots-section">
                <div id="gv-view-loadout" class="gv-view-container">
                    <div class="col-header" style="color:#00aaff; border-color:#00aaff;">TACTICAL LOADOUT</div>
                    <div class="gv-grid" id="gv-slots-area">
                        </div>
                </div>

                <div id="gv-view-inventory" class="gv-view-container" style="display:none;">
                    <div class="col-header" style="color:#00ffaa; border-color:#00ffaa;">STORAGE INVENTORY</div>
                    <div class="gv-inventory-grid" id="gv-inventory-area">
                        </div>
                </div>
            </div>

            <div class="gv-info-section">
                <div class="col-header" style="color:#ffd700; border-color:#ffd700;">DATA ANALYSIS</div>
                <div class="gv-info-panel">
                    <div id="gv-info-placeholder">
                        <div style="font-size: 40px; margin-bottom: 10px; opacity: 0.3;">🔎</div>
                        請點擊左側物品<br>查看詳細數據與等級加成
                    </div>
                    <div id="gv-info-content" style="display:none; height: 100%; flex-direction: column;">
                        <div class="gv-title-row">
                            <div class="gv-info-title" id="gv-info-title"></div>
                            <div id="gv-info-badges" style="display:flex; gap:5px; flex-wrap:wrap;"></div>
                        </div>
                        <div class="gv-info-type" id="gv-info-type"></div>
                        <div class="gv-info-desc glass-panel" id="gv-info-desc"></div>
                        <div class="gv-info-stats" id="gv-info-stats"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="data.js"></script>
    <script src="utils.js"></script>
    
    <script src="sharedState.js"></script>
    <script src="combatState.js"></script>

    <script src="bossData.js"></script>
    <script src="bossPatterns.js"></script>
    <script src="bossSystem.js"></script>
    <script src="bossRender.js"></script>

    <script src="uiHelpers.js"></script>
    <script src="inventory.js"></script>

    <script src="levelUpSystem.js"></script>
    <script src="shopSystem.js"></script>
    <script src="forgeSystem.js"></script>

    <script src="weaponSystem.js"></script>
    <script src="combatPhysics.js"></script>
    <script src="combatRender.js"></script>

    <script src="enemySystem.js"></script>
    <script src="main.js"></script>

</body>
</html>